第3回 任意提出課題

# 概要
講義中のノートブックを元に５つの質問文に対するLLMの回答およびRAGを使った改良について演習を行なった。
対象となる質問は、松尾研の講義受講規約についてのもので、一般には公開されていないため、RAGの効果を確かめるには最適と判断した。また、RAGのデータ生成には「松尾・岩澤研究室 講座受講規約」のテキスト部分を使用した。

# 1. 問題文について
口座受講規約を読まないと正しく答えられなさそうな以下５問を準備した。
questions = [
    "松尾・岩澤研究室の講座において、退会した後も研究室が受講者の情報を利用できる条件とは何ですか？",
    "未成年者が講座を受講するには、どのような条件が求められますか？",
    "受講者が他の人のSlack投稿をSNSで共有することは、講座規約上どう扱われますか？",
    "講座で使用された資料や動画を、受講後に再利用・再配布することは許可されていますか？",
    "講義中にノイズなどのトラブルを発生させた場合、講座への参加はどうなりますか？"
]

# 2. RAGの実装方法と工夫点
講義ノートブックと同様に「infly/inf-retriever-v1-1.5b」を使ったが、参照テキストが大きくなるとGPUメモリで処理できなかったので、ここだけCPU処理とした

# 3. 評価結果
LLM(gpt-4o-mini) による評価結果は以下となった。
LLMには、点数をつけるだけでなく理由も説明させるようにして、RAGの改善に役立てられるように工夫した。

```python
    prompt = (
        "あなたはAIによる回答の評価者です。\n\n"
        "以下はある質問に対するユーザーの回答と、その模範解答（golden answer）です。\n"
        "以下の3つの観点でユーザー回答を0〜5点で評価し、それぞれについて簡単な理由を説明してください。\n\n"
        "【観点】\n"
        "1. 正確性（Correctness）: golden answerと矛盾せず、事実として正しいか？\n"
        "2. 完全性（Completeness）: golden answerに含まれる要点がカバーされているか？\n"
        "3. 関連性（Relevance）: 回答が質問に直接関連し、無関係な内容を含んでいないか？\n\n"
        "【出力形式】（必ず以下の形式で）\n"
        "Correctness: <スコア>（理由）\n"
        "Completeness: <スコア>（理由）\n"
        "Relevance: <スコア>（理由）\n\n"
        "### 質問:\n{query}\n\n"
        "### ユーザーの回答:\n{user_answer}\n\n"
        "### 模範解答:\n{golden_answer}\n"
    ).format(query=query, user_answer=user_answer, golden_answer=golden_answer)
```


| # | 質問 | Baseline回答 | RAG回答 | 模範解答 | Baseline正確性 | Baseline完全性 | Baseline関連性 | RAG正確性 | RAG完全性 | RAG関連性 |
|---|------|--------------|---------|----------|----------------|----------------|----------------|------------|------------|------------|
| 0 | 松尾・岩澤研究室の講座において、退会した後も研究室が受講者の情報を利用できる条件とは何ですか？ | 松尾・岩澤研究室の講座において、退会後も研究室が受講者の情報を利用できる条件は、研究室のポリシーや契約内容に従い情報利用が可能とされる場合があると考えられます。 | 松尾・岩澤研究室の講座において、退会した後も研究室が受講者の情報を利用できる条件は、「本プライバシーポリシー」に基づき情報利用が可能とされています。 | 受講者が退会した後であっても、在籍中に取得された情報はプライバシーポリシーを遵守する形で、本研究室が利用できる。 | Correctness: 3（ユーザーの回答は、一般的な条件を述べており、一部正しいですが、具体的な規約の記載に触れていません。） | Completeness: 2（ユーザーの回答は、受講者の情報利用についての一般的な条件を述べているが、詳細な条件や規約の記載が不足しています。） | Relevance: 4（ユーザーの回答は質問に関連した内容を提供しているが、具体的に研究室の規約に基づく説明が不足しています。） | Correctness: 5（ユーザーの回答は事実として正しく、プライバシーポリシーに従うことを明記しています。） | Completeness: 3（ユーザーの回答は基本的な条件を示していますが、在籍中に取得された情報という点が明確ではありません。） | Relevance: 5（ユーザーの回答は質問に直接関連しており、無関係な内容は含まれていません。） |
| 1 | 未成年者が講座を受講するには、どのような条件が求められますか？ | 未成年者が講座を受講するには、以下の条件が求められます。1. 年齢制限:... | 未成年者が講座を受講するには、以下の条件が求められます。未成年者の本人による申込と法定代理人の同意 | 未成年者が受講を希望する場合は、事前に法定代理人の同意を得ている必要があります。 | Correctness: 4（ユーザーの回答は、未成年者が講座を受講する際に保護者または親権者の同意が必要であることを正しく述べていますが、法定代理人の範囲がやや限定的です。） | Completeness: 3（ユーザーの回答にはさまざまな条件が列挙されており、具体的な講座規約の要点がやや不足しています。） | Relevance: 5（ユーザーの回答は、未成年者の受講条件に関連した情報を提供しており、無関係な内容は含まれていません。） | Correctness: 5（ユーザーの回答は、未成年者が講座を受講する際に法定代理人の同意が必要であることを正確に述べています。） | Completeness: 4（ユーザーの回答は、「法定代理人の同意」という重要な要点を含んでいますが、細かい条件の記載がやや不足しています。） | Relevance: 5（ユーザーの回答は、質問に対して直接関連しており、無関係な内容が含まれていません。） |
| 2 | 受講者が他の人のSlack投稿をSNSで共有することは、講座規約上どう扱われますか？ | 講座規約上、受講者が他の人のSlack投稿をSNSで共有することは、多様で、明確な回答はありませんが、投稿者の同意があれば共有可能と考えられます。 | 講座規約に記載されている通り、受講者が他の人のSlack投稿をSNSで共有することは、個人情報に該当しない部分については許可される場合があります。 | Slack上でのやりとりやスクリーンショットをSNSにアップすることは禁止されています。 | Correctness: 2（ユーザーの回答は、正確性としては講座規約に対する具体的なルールに触れていません。） | Completeness: 2（ユーザーの回答は多くの要点に言及しているが、最も重要な「Slack投稿のSNS共有は禁止」という点が抜けています。） | Relevance: 3（ユーザーの回答は質問に関連しているが、一般論や考慮点に重きを置きすぎています。） | Correctness: 1（ユーザーの回答は、模範解答の具体的な禁止事項と矛盾しているため、正確性が低いです。） | Completeness: 1（ユーザーの回答は、模範解答の主旨である「禁止」という重要な点が抜けています。） | Relevance: 2（ユーザーの回答は質問に関連性がある部分もあるが、核心に触れられていません。） |
| 3 | 講座で使用された資料や動画を、受講後に再利用・再配布することは許可されていますか？ | 講座で使用された資料や動画の再利用・再配布については、講座の主催者や提供者によって異なります。 | いいえ、講座で使用された資料や動画を、受講後に再利用・再配布することは許可されていません。 | 講義資料や動画のURLについて、受講後であっても無断での再利用や配布は認められていません。 | Correctness: 2（ユーザーの回答は一般論として正しい面がありますが、具体的に無断再利用・再配布が禁止されている点が抜けています。） | Completeness: 2（ユーザーの回答は再利用や再配布が許可される場合の条件をいくつか挙げていますが、規約の明確な禁止事項が抜けています。） | Relevance: 4（ユーザーの回答はテーマに関連しており、一般的な条件や例を挙げています。） | Correctness: 5（ユーザーの回答は講座の規約に基づいており、正確です。具体的には再利用・再配布が禁止されていることを明記しています。） | Completeness: 4（ユーザーの回答は、一般的な内容と規約の具体的な引用を含んでいますが、細かい条件の記載がやや不足しています。） | Relevance: 5（質問について直接的に答えており、資料や動画の再利用・再配布に関する内容が明確です。） |
| 4 | 講義中にノイズなどのトラブルを発生させた場合、講座への参加はどうなりますか？ | 講義中にノイズなどのトラブルが発生した場合、講座への参加は状況によって異なります。 | 講義中にノイズなどのトラブルが発生した場合、当研究室の判断により、受講環境が改善するまでの間、参加を一時停止されることがあります。 | 受講者のインフラに起因するノイズ等のトラブルで他の受講環境に悪影響がある場合、改善するまで参加停止となる。 | Correctness: 3（ユーザーの回答は、トラブルが発生した場合の参加に関する状況を概ね正しく説明していますが、規約の具体的な記載が不足しています。） | Completeness: 3（ユーザーの回答は様々なケースや対応を考慮しているが、模範解答の要点がやや不足しています。） | Relevance: 4（ユーザーの回答は講座への参加に関連する内容を扱っており、講義中のトラブルに関する説明が含まれています。） | Correctness: 5（ユーザーの回答は、模範解答と矛盾せず、事実として正しい内容です。） | Completeness: 4（ユーザーの回答は、模範解答の要点をほぼカバーしていますが、「一時停止」という表現がやや曖昧です。） | Relevance: 5（回答は質問に直接関連しており、無関係な内容は含まれていません。講義中のトラブルに関する説明が明確です。） |


この表は、5つの質問それぞれについて、Baseline（通常のLLM回答）とRAG（検索拡張生成）の両方のアプローチにおける、Correctness（正確性）、Completeness（完全性）、Relevance（関連性）の評価結果を示しています。評価は1から5のスケールで行われています。

## 3.1 RAGの評価がベースラインより低い回答
質問； 受講者が他の人のSlack投稿をSNSで共有することは、講座規約上どう扱われますか？
回答： 講座規約に記載されている通り、受講者が他の人のSlack投稿をSNSで共有することは、個人情報に該当しない部分については許可される場合があります。

原因を調べるために、RAGで参照されたチャンクを見てみることにした。

```
=== [質問 2] ===
受講者が他の人のSlack投稿をSNSで共有することは、講座規約上どう扱われますか？

--- 類似チャンク（Top 5） ---
[1] 類似度スコア: 0.8818
内容: 2. なお、本規約より受講者は受講者からの質問や個人情報に該当しない部分については研究室がデータの利活用する事を了承するものとします...
----------------------------------------
[2] 類似度スコア: 0.8758
内容: 第1条（適用範囲）
1. 本規約は、講座を受講するすべての対象者(以下、受講者)と当研究室との間における一切の関係に適用されるものとします...
----------------------------------------
[3] 類似度スコア: 0.8706
内容: 2. 受講者が各講座の受講を修了していたとしても受講者登録が行われている場合、当研究室から各受講者に新たな講座案内等の情報発信を行うことがあります...
----------------------------------------
[4] 類似度スコア: 0.8672
内容: 第6条（譲渡の禁止）
1. 受講者は、受講者としての資格、地位、権利または義務につき、第三者に移転もしくは譲渡し、または担保に供し、その他一切の処分をすることはできません...
----------------------------------------
[5] 類似度スコア: 0.8629
内容: 第3条（受講申込）
1. 受講希望者は本規約に同意の上、当研究室の定める方法によって受講申込を行い、当研究室がこれを承認することによって完了するものとします...
----------------------------------------
```

**SNSやslackについて、参照テキストの規約には記載されているのにも関わらず、文章の意味が似ている(Embeddingの類似度が高い)ものが参照されていることが分かった。これを改善する一つの方法は、キーワード検索を組み合わせることが考えられる。**

# 4. 実験の工夫
LLMの評価を完全に事実に基づくように実施することが難しかったため、２つの評価方法を追加した

## 4.1 事実誤認の指摘
LLMを使い、参照文章を違反している記述があるかどうかをチェックした。
```python
    prompt = (
        "You are a strict factual checker. Given a reference document, a question, and a user answer, "
        "identify any factual inaccuracies in the user answer based on the reference.\n\n"
        "If the user answer contains claims not supported by the reference, or contradicts it, list them.\n"
        "If there are no factual errors, simply say: None.\n\n"
        "### Reference Document:\n{reference_text}\n\n"
        "### Question:\n{query}\n\n"
        "### User Answer:\n{user_answer}\n\n"
        "Factual Errors:"
    ).format(
        reference_text=reference_text,
        query=query,
        user_answer=user_answer
    )
```

## 4.2 ベースライン vs RAG の相対評価
ベースラインとRAGを同時にLLMに入力し、どちらが良いかを評価した
```python
    prompt = (
        "You are an impartial evaluator. Based ONLY on the reference document, determine which answer is more accurate and appropriate for the given question.\n\n"
        "Choose the better one strictly based on factual correctness, completeness, and relevance to the question.\n"
        "If both answers are equally good, say: Equal\n"
        "Choose from: Baseline / RAG / Equal\n\n"
        "### Reference Document:\n{reference_text}\n\n"
        "### Question:\n{query}\n\n"
        "### Baseline Answer:\n{baseline_answer}\n\n"
        "### RAG Answer:\n{rag_answer}\n\n"
        "Better Answer:".format(
            reference_text=reference_text,
            query=query,
            baseline_answer=baseline_answer,
            rag_answer=rag_answer
        )
```

## 4.3 追加評価の結果

| 質問番号 | Baseline エラー | RAG エラー |
|---------|----------------|------------|
| 1 | 1. 退会後の情報利用条件について、研究室のポリシーと契約内容に依存すると述べているが、具体的なプライバシーポリシーに基づく利用権について言及がない<br>2. 「退会後においても上記の債務はその債務が履行されるまで消滅しません」という重要な条項の言及がない | 1. 「本プライバシーポリシー」という表現が不正確<br>2. 退会後も研究室の規則に従って情報が使用可能である点の言及がない |
| 2 | 1. 未成年者の同意要件について、保護者や親権者に限定して説明しているが、法的代理人や後見人なども含む必要がある<br>2. 同意要件の法的文脈が不十分 | エラーなし |
| 3 | 1. Slack投稿のSNS共有について「明確な答えがない」と述べているが、規約では明確に禁止されている<br>2. 投稿者の同意があれば共有可能という誤った解釈<br>3. 規約の厳格な性質が反映されていない | 1. 個人情報に該当しない部分の共有について誤った解釈<br>2. 特定の条件下での共有許可について誤った解釈 |
| 4 | 1. 資料の再利用・再配布について、主催者次第という誤った解釈<br>2. 著作権許可や公開資料の場合の再利用可能性について誤った推測<br>3. 規約の厳格な制限が反映されていない | エラーなし |
| 5 | 1. トラブル発生時の参加継続可能性について誤った解釈<br>2. 技術的問題発生時の再放送や録画提供について誤った推測 | エラーなし |

この表は、各質問に対するBaselineとRAGの回答における事実誤認を比較したものです。エラーなしと記載されている箇所は、参照文書に基づいて事実誤認がないと判断された回答を示しています。

# 5. 考察・今後の課題

## 5.1 考察
参照文書が受講規約で、記載内容が短くまとまっていたため、RAGの検索には有利に働いたと考えられる。
しかし、設問2のようにキーワードが異なる文章を類似性から選んでしまうケースもあることが分かった。
自動評価については、概ね人間の判断と同じ結果ではあったが、設問が５問しかなかったため、より多くの質問文で試してみる必要がある。

## 5.2 今後の課題
- キーワード検索とのハイブリッド化
キーワード検索とのハイブリッド化
Embedding類似度検索だけでなく、キーワード検索を組み合わせることで、重要な記述を確実に参照できるようにする。特に規約やFAQのような明確なキーワードが存在する文書では、ハイブリッド検索の有効性が高いと考えられる。

- プロンプト設計・チャンク化手法の最適化
参照文書の要点をより的確に抽出し、RAGの生成品質を高めるためのプロンプト設計や、情報のチャンク化・要約方法の最適化が必要。

- 評価手法の多様化と客観性向上
LLMによる自動評価だけでなく、複数人による人手評価も必要。

- 非機能要求の検証
記述の正確さだけでなく、回答の流暢さ、回答速度などの評価指標も導入して完成度を高めたい


